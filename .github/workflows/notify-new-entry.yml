name: Notify Subscribers of New Entry

on:
  push:
    branches: [main]
    paths:
      - '[0-9]*.html'

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Check for new HTML files
        id: check
        run: |
          # Get list of new .html files (dated entries only, exclude index.html)
          NEW_FILES=$(git diff --name-only HEAD^ HEAD | grep -E '^[0-9]+\.[0-9]+\.html$' || true)
          
          if [ -n "$NEW_FILES" ]; then
            # Extract the date from filename (e.g., "10.22" from "10.22.html")
            ENTRY_DATE=$(echo "$NEW_FILES" | head -1 | sed 's/\.html$//')
            echo "new_entry=$ENTRY_DATE" >> $GITHUB_OUTPUT
            echo "has_new=true" >> $GITHUB_OUTPUT
            echo "Found new entry: $ENTRY_DATE"
          else
            echo "has_new=false" >> $GITHUB_OUTPUT
            echo "No new entries found"
          fi

      - name: Get subscriber list
        if: steps.check.outputs.has_new == 'true'
        id: subscribers
        run: |
          # Read subscribers from JSON file
          EMAILS=$(cat subscribers.json | jq -r '.subscribers[]' | tr '\n' ',' | sed 's/,$//')
          echo "emails=$EMAILS" >> $GITHUB_OUTPUT
          echo "Subscribers: $EMAILS"

      - name: Send notification emails
        if: steps.check.outputs.has_new == 'true' && steps.subscribers.outputs.emails != ''
        run: |
          IFS=',' read -ra EMAIL_ARRAY <<< "${{ steps.subscribers.outputs.emails }}"
          
          for email in "${EMAIL_ARRAY[@]}"; do
            curl -X POST https://api.sendgrid.com/v3/mail/send \
              -H "Authorization: Bearer ${{ secrets.SENDGRID_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d @- <<EOF
          {
            "personalizations": [{
              "to": [{"email": "$email"}]
            }],
            "from": {"email": "nathaniel@burnfolder.com", "name": "burnfolder"},
            "subject": "new burnfolder entry: ${{ steps.check.outputs.new_entry }}",
            "content": [{
              "type": "text/html",
              "value": "<!DOCTYPE html><html><head><style>body{font-family:'Courier New',Courier,monospace;background:#fff;color:#000;padding:40px;line-height:1.6;margin:0}a{color:#000;text-decoration:none;border-bottom:2px solid #000;padding-bottom:2px;font-size:20px}.header{font-size:24px;margin-bottom:30px;border-bottom:2px solid #000;padding-bottom:10px}.entry-title{font-size:32px;margin:30px 0;font-weight:bold}.cta{margin:30px 0}.footer{margin-top:40px;padding-top:20px;border-top:2px solid #000;font-size:12px;opacity:0.6}</style></head><body><div class=\"header\">burnfolder</div><p>new audio entry:</p><div class=\"entry-title\">${{ steps.check.outputs.new_entry }}</div><div class=\"cta\"><a href=\"https://burnfolder.com/${{ steps.check.outputs.new_entry }}.html\">listen now â†’</a></div><div class=\"footer\">to unsubscribe, reply to this email</div></body></html>"
            }]
          }
          EOF
          done
